<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thổi Nến - NTS</title>
    <style>
        :root { --bg-color: #080808; }
        body {
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
            perspective: 1000px;
            transition: opacity 2s ease-out;
        }
        .vignette {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 30%, #000 90%);
            z-index: 50; pointer-events: none;
        }
        .ambient-light {
            position: absolute;
            width: 800px; height: 800px;
            background: radial-gradient(circle, rgba(255,147,41,0.15) 0%, transparent 60%);
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            transition: opacity 0.2s;
            mix-blend-mode: screen;
        }
        .cake-container { position: relative; width: 300px; height: 300px; z-index: 10; transform-style: preserve-3d; transform: rotateX(5deg); }
        .plate { width: 340px; height: 140px; position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(to bottom, #ddd, #999); border-radius: 50%; box-shadow: 0 15px 40px rgba(0,0,0,0.8), inset 0 2px 5px rgba(255,255,255,0.5); z-index: 2; }
        .cake-body { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 280px; height: 140px;
            background: #3e2723; background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(to right, #4e342e, #3e2723, #281a16);
            background-size: 4px 4px, 100% 100%; border-radius: 50% 50% 10px 10px / 30px 30px 10px 10px; z-index: 3;
            box-shadow: inset 0 -10px 30px rgba(0,0,0,0.8); }
        .cake-top { position: absolute; top: -50px; left: 0; width: 280px; height: 100px;
            background: radial-gradient(ellipse at 40% 40%, #ffecb3 0%, #ffca28 60%, #ff8f00 100%); border-radius: 50%; z-index: 5;
            box-shadow: inset 0 5px 10px rgba(255,255,255,0.5), 0 2px 4px rgba(0,0,0,0.2); }
        .drip { position: absolute; background: #ffca28; width: 30px; height: 60px; border-radius: 0 0 15px 15px; box-shadow: inset 2px -2px 5px rgba(0,0,0,0.1); z-index: 4; }
        .drip:nth-child(1){left:30px;height:50px}.drip:nth-child(2){left:80px;height:70px;width:35px}
        .drip:nth-child(3){left:130px;height:45px}.drip:nth-child(4){left:180px;height:60px;width:25px}
        .drip:nth-child(5){left:230px;height:40px}

        .candle-wrapper { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); z-index: 20; perspective: 500px; }
        .candle-stick { position: relative; width: 20px; height: 80px; background: linear-gradient(90deg,#cfd8dc 0%,#fff 40%,#b0bec5 100%);
            border-radius: 3px; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .candle-stick::before { content:''; position:absolute; top:0; left:0; width:100%; height:15px;
            background: radial-gradient(circle at top,rgba(255,235,59,0.9),transparent); border-radius:3px 3px 0 0;
            opacity:0.8; filter:blur(2px); animation:wax-glow .1s infinite alternate; }
        .wick { position:absolute; top:-12px; left:50%; transform:translateX(-50%); width:2px; height:12px; background:#222; border-radius:2px; }
        .wick::after { content:''; position:absolute; top:0; left:-1px; width:4px; height:4px; background:#ff5722; border-radius:50%; box-shadow:0 0 5px #ff5722; opacity:0.9; }

        .flame-container { position:absolute; bottom:100%; left:50%; width:40px; height:60px; transform:translateX(-50%);
            transform-origin:center bottom; filter:blur(.5px); }
        .flame-base-blue { position:absolute; bottom:0; left:50%; width:14px; height:20px; transform:translateX(-50%);
            background:rgba(0,100,255,0.6); border-radius:50%; filter:blur(4px); opacity:.8; z-index:10; }
        .flame-body { position:absolute; bottom:5px; left:50%; width:16px; height:45px; transform:translateX(-50%);
            background:linear-gradient(to top,rgba(255,150,0,.5),rgba(255,200,0,.8)); border-radius:50% 50% 20% 20%;
            box-shadow:0 0 10px rgba(255,100,0,.6); animation:flicker-shape .1s infinite alternate; z-index:9; }
        .flame-core { position:absolute; bottom:5px; left:50%; width:8px; height:25px; transform:translateX(-50%);
            background:#fff; border-radius:50% 50% 30% 30%; box-shadow:0 0 15px #fff; opacity:.9; z-index:11;
            animation:flicker-core .15s infinite alternate-reverse; }
        .flame-aura { position:absolute; bottom:-10px; left:50%; width:80px; height:80px; transform:translateX(-50%);
            background:radial-gradient(circle,rgba(255,100,0,.2) 0%,transparent 70%); border-radius:50%; z-index:1; }

        @keyframes flicker-shape { 0%{transform:translateX(-50%) scale(1) skewX(0deg);height:45px} 100%{transform:translateX(-50%) scale(1.03) skewX(1deg);height:47px} }
        @keyframes flicker-core { 0%{opacity:.9;height:25px} 100%{opacity:1;height:27px} }
        @keyframes wax-glow { 0%{opacity:.6} 100%{opacity:.9} }

        .smoke-particle { position:absolute; background:radial-gradient(circle,rgba(200,200,200,.5),transparent);
            border-radius:50%; filter:blur(5px); z-index:30; pointer-events:none; }
        @keyframes smoke-rise { 0%{opacity:.5;transform:translate(-50%,0) scale(.5)} 100%{opacity:0;transform:translate(var(--dx),-100px) scale(3)} }

        /* ĐẾM NGƯỢC ĐẸP - ĐÃ BỎ NÚT */
        .countdown-overlay {
            position:fixed; top:0; left:0; width:100%; height:100%; background:#000;
            display:none; flex-direction:column; justify-content:center; align-items:center; z-index:999;
        }
        .countdown-number {
            font-size:280px; font-weight:100; color:#fff; margin-bottom:40px;
            text-shadow:0 0 40px rgba(255,255,255,.3);
        }
        .countdown-text {
            font-size:28px; color:#ff6b6b; font-weight:500;
        }
        .countdown-text::after { content:" ❤️"; animation:heartbeat 1.5s infinite; }
        @keyframes heartbeat { 0%,100%{transform:scale(1)} 50%{transform:scale(1.3)} }

        .controls { position:fixed; bottom:30px; text-align:center; z-index:100; width:100%; }
        button { background:linear-gradient(45deg,#ff6f00,#ffca28); border:none; padding:15px 40px; color:#000;
            font-weight:800; font-size:18px; border-radius:50px; cursor:pointer; box-shadow:0 0 20px rgba(255,111,0,.6);
            transition:all .3s; }
        button:hover { transform:scale(1.05); box-shadow:0 0 40px rgba(255,111,0,.9); }
        button:disabled { background:#555; color:#aaa; box-shadow:none; cursor:not-allowed; }
        #status { margin-top:15px; font-size:16px; color:#aaa; font-style:italic; }
    </style>
</head>
<body>
    <div class="vignette"></div>
    <div class="ambient-light" id="ambientLight"></div>

    <div class="cake-container">
        <div class="plate"></div>
        <div class="cake-body">
            <div class="icing-drips">
                <div class="drip"></div><div class="drip"></div><div class="drip"></div><div class="drip"></div><div class="drip"></div>
            </div>
            <div class="cake-top">
                <div style="position:absolute;top:30px;left:60px;width:8px;height:8px;background:#f44336;border-radius:50%;box-shadow:1px 1px 2px rgba(0,0,0,.3);"></div>
                <div style="position:absolute;top:60px;left:120px;width:8px;height:8px;background:#4caf50;border-radius:50%;box-shadow:1px 1px 2px rgba(0,0,0,.3);"></div>
                <div style="position:absolute;top:40px;left:180px;width:8px;height:8px;background:#2196f3;border-radius:50%;box-shadow:1px 1px 2px rgba(0,0,0,.3);"></div>
                
                <div class="candle-wrapper">
                    <div class="candle-stick">
                        <div class="wick"></div>
                        <div class="flame-container" id="realFlame">
                            <div class="flame-aura"></div>
                            <div class="flame-base-blue"></div>
                            <div class="flame-body"></div>
                            <div class="flame-core"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button id="startBtn">BẬT MIC ĐỂ THỔI</button>
        <div id="status">Hãy bật mic và thổi thật mạnh nhé!</div>
    </div>

    <!-- Overlay đếm ngược (đã bỏ nút) -->
    <div class="countdown-overlay" id="countdownOverlay">
        <div class="countdown-number" id="countdownNumber">10</div>
        <div class="countdown-text">Chuẩn bị đón điều bất ngờ nào...</div>
    </div>

    <script>
        const LINK_CHUYEN_HUONG = "happy.html";
        const BLOW_THRESHOLD = 0.09;

        const startBtn = document.getElementById('startBtn');
        const statusText = document.getElementById('status');
        const flameContainer = document.getElementById('realFlame');
        const ambientLight = document.getElementById('ambientLight');
        const countdownOverlay = document.getElementById('countdownOverlay');
        const countdownNumber = document.getElementById('countdownNumber');

        let audioContext, analyser, microphone, dataArray;
        let isBlowOut = false;
        let flickerInterval;

        function startAmbientFlicker() {
            flickerInterval = setInterval(() => {
                if (isBlowOut) return;
                const o = 0.7 + Math.random() * 0.3;
                const s = 0.98 + Math.random() * 0.04;
                ambientLight.style.opacity = o * 0.2;
                ambientLight.style.transform = `translate(-50%,-50%) scale(${s})`;
            }, 50);
        }

        async function initMic() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;
                analyser.smoothingTimeConstant = 0.4;
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                startBtn.innerHTML = "Đang nghe...";
                startBtn.disabled = true;
                statusText.innerText = "Thổi thật mạnh vào mic nào!";

                startAmbientFlicker();
                detectBlow();
            } catch (e) {
                statusText.innerText = "Không bật được mic. Thử lại trên Chrome nhé!";
            }
        }

        function detectBlow() {
            if (isBlowOut) return;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for (let i = 0; i < 20; i++) sum += dataArray[i];
            const vol = sum / 20 / 255;
            updateFlamePhysics(vol);
            if (vol > BLOW_THRESHOLD) extinguishFlame();
            else requestAnimationFrame(detectBlow);
        }

        function updateFlamePhysics(v) {
            const lean = Math.random() > 0.5 ? v * 60 : v * -60;
            const scaleY = 1 - v;
            const op = 1 - v * 0.5;
            flameContainer.style.transform = `translateX(-50%) skewX(${lean}deg) scaleY(${scaleY})`;
            flameContainer.style.opacity = op;
            ambientLight.style.opacity = (1 - v) * 0.3;
        }

        function extinguishFlame() {
            isBlowOut = true;
            clearInterval(flickerInterval);
            flameContainer.style.transition = "all .3s ease";
            flameContainer.style.opacity = 0;
            flameContainer.style.transform = "translateX(-50%) scale(0)";
            ambientLight.style.opacity = 0;

            // Tắt glow sáp
            const style = document.createElement('style');
            style.innerHTML = ".candle-stick::before{opacity:0 !important}";
            document.head.appendChild(style);

            spawnSmoke();
            if (microphone) microphone.disconnect();

            setTimeout(() => {
                countdownOverlay.style.display = "flex";
                startCountdown();
            }, 1500);
        }

        function spawnSmoke() {
            const c = document.querySelector('.candle-wrapper');
            for (let i = 0; i < 25; i++) {
                const s = document.createElement('div');
                s.className = 'smoke-particle';
                const size = 8 + Math.random() * 20;
                s.style.width = s.style.height = size + 'px';
                s.style.top = '-10px';
                s.style.left = '50%';
                s.style.setProperty('--dx', (Math.random() - 0.5) * 120 + 'px');
                s.style.animation = `smoke-rise ${1.8 + Math.random() * 1.5}s ease-out forwards`;
                c.appendChild(s);
            }
        }

        function startCountdown() {
            let sec = 10;
            countdownNumber.textContent = sec;
            const timer = setInterval(() => {
                sec--;
                countdownNumber.textContent = sec;
                if (sec <= 0) {
                    clearInterval(timer);
                    document.body.style.opacity = 0;
                    setTimeout(() => window.location.href = LINK_CHUYEN_HUONG, 2000);
                }
            }, 1000);
        }

        startBtn.onclick = initMic;

        document.addEventListener('touchstart', () => {
            if (audioContext && audioContext.state === 'suspended') audioContext.resume();
        }, { once: true });
    </script>
</body>
</html>
